{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}{% endblock %}</h1>
  <style type='text/css'>
    ul { list-style: none; }
    #recordingslist audio { display: block; margin-bottom: 10px; }
  </style>
{% endblock %}

{% block content %}

<!--
<p>IPA: </p>
<li id="ipa"  contenteditable="true">
    <small>{{ _ipa | safe }}</small>
</li>
<br>
-->

<!--
<form action="{{ url_for('app.record') }}" autocomplete="off" method="POST"">
    <dl>
      <dt><small>Please type a sentence</small>:
      <dd><textarea name=input rows=2 cols=80 placeholder="Monica, running down the street, tripped.">{{ posts|safe}}</textarea> 
      <br/>
      <dd><input type=submit value=checkscore>
    </dl>
</form>
-->

<!--
<p>Txt: </p>
<li id="txt" contenteditable="true">
    <small>{{ posts | safe }}</small>
</li>
<br>
-->

<!--
<p>Languages: </p>
<li id="txt" contenteditable="true">
    <small>{{ posts | safe }}</small>
</li>
<br>
-->


<!--
<p>You spoke: </p>
<div id="controls">
    
    <button onclick="startRecording(this);">record</button>
    <button onclick="stopRecording(this);" disabled>stop</button>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

</div>
-->

<!--
<p>You spoke: </p>
<div id="controls">
    
    <button onclick="startRecording(this);">record</button>
    <button onclick="stopRecording(this);" disabled>stop</button>
    
    <input type="file" accept="audio/*" capture="microphone" id="recorder">
    <audio id="player" controls>
    </audio>


</div>
<br>
-->

<div id="controls">
    <form action = "/uploader" method = "POST" enctype = "multipart/form-data">
          <dl>
            <label for="language">Choose Language
                <select name="language" id="language" required>
                        <option value="0" selected>American English</option>
                        <option value="1">Mandarin</option>
                        <option value="2">Cantonese?</option>
                        <option value="3">Other?</option>
                    </select>
            </label>
            <br/>

            <dt>Please type a sentence:
            <dd><textarea name=input rows=1 cols=80 placeholder="Monica, running down the street, tripped.">{{ posts|safe}}</textarea> 
            <br/>
            <dt>Upload an audio file <small>(wav)</small> containing the sentence
            <dd><input type = "file" name = "file" accept="audio/*" capture="microphone" id="recorder">
            <br/>  
            <br/>
            <dd><input type=submit value=Checking>
             <br/>
             <br/>
             {% for word, _ipa in diff_dict.items() %}
                 <dd> {{ word|safe}} -  <mark>{{ _ipa|safe }}</mark>
             {% endfor %}
            <br/>
            <br/>
            <br/>
            <dt> [TODO-TTS] Listening ... 
            <dt> <del>[TODO-features] using Spectrograms not txt features to check ... </del>

            <br/>
         </dl>
    </form>

</div>

<br>


<h2>Recordings</h2>
    <ul id="recordingslist"></ul>
  
<h2>Log</h2>
   <pre id="log"></pre>

   <!--
<script>
    recorder.onchange = function(e){
  var sound = document.getElementById('sound');
  sound.src = URL.createObjectURL(this.files[0]);
  // not really needed in this exact case, but since it is really important in other cases,
  // don't forget to revoke the blobURI when you don't need it
  sound.onend = function(e) {
    URL.revokeObjectURL(this.src);
  }
}

 </script>
-->


<script>

      //
        function __log(e, data) {
          log.innerHTML += "\n" + e + " " + (data || '');
        }
      
        var audio_context;
        var recorder;
      
        function startUserMedia(stream) {
          var input = audio_context.createMediaStreamSource(stream);
          __log('Media stream created.');
      
          // Uncomment if you want the audio to feedback directly
          //input.connect(audio_context.destination);
          //__log('Input connected to audio context destination.');
          
          recorder = new Recorder(input);
          __log('Recorder initialised.');
        }
      
        function startRecording(button) {
          recorder && recorder.record();
          button.disabled = true;
          button.nextElementSibling.disabled = false;
          __log('Recording...');
        }
      
        function stopRecording(button) {
          recorder && recorder.stop();
          button.disabled = true;
          button.previousElementSibling.disabled = false;
          __log('Stopped recording.');
          
          // create WAV download link using audio data blob
          createDownloadLink();
          
          recorder.clear();
        }

        //
        function sendData(blob) {
        //
        //fetch()
        }
      
        function createDownloadLink() {
          recorder && recorder.exportWAV(function(blob) {
            var url = URL.createObjectURL(blob);
            var li = document.createElement('li');
            var au = document.createElement('audio');
            var hf = document.createElement('a');
            
            au.controls = true;
            au.src = url;
            hf.href = url;
            hf.download = new Date().toISOString() + '.wav';
            hf.innerHTML = hf.download;
            li.appendChild(au);
            li.appendChild(hf);

            //upload link
            sendData(blob);

	       li.appendChild(document.createTextNode (" "))//add a space in between
	       li.appendChild(upload)//add the upload link to li

            //
            recordingslist.appendChild(li);
          });
        }
      
        window.onload = function init() {
          try {
            // webkit shim
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
            window.URL = window.URL || window.webkitURL;
            
            audio_context = new AudioContext;
            __log('Audio context set up.');
            __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
          } catch (e) {
            alert('No web audio support in this browser!');
          }
          
          navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
            __log('No live audio input: ' + e);
          });
        };
        </script>
      
        <script src="../../static/recorder.js"></script>
    

<!--
<script src="record.js"></script>
<button id="action" onclick="handleAction()">Start ...</button>
-->

<!--
<input type="file" accept="audio/*" capture id="recorder">
<audio id="player" controls></audio>
<script>
  var recorder = document.getElementById('recorder');
  var player = document.getElementById('player');
  recorder.addEventListener('change', function(e) {
    var file = e.target.files[0];
    // Do something with the audio file.
    player.srcObject = file;
  });
</script>
-->

<!--
<ul id="recorder" class="mfb-component--br mfb-zoomin" data-mfb-toggle="hover">
        <li class="mfb-component__wrap">
          <a href="#" id="record" class="mfb-component__button--main">
            <i class="mfb-component__main-icon--resting fa fa-microphone"></i>
            <i class="mfb-component__main-icon--active fa fa-times"></i>
          </a>
          <ul class="mfb-component__list">
            <li>
              <a href="#" id="stop-record" data-mfb-label="Stop" class="mfb-component__button--child">
                <i class="mfb-component__child-icon fas fa-stop"></i>
              </a>
            </li>
            <li>
              <a href="#" id="start-record" data-mfb-label="Start" class="mfb-component__button--child ">
                <i class="mfb-component__child-icon fas fa-circle"></i>
              </a>
            </li>
          </ul>
        </li>
</ul>
-->
{% endblock %}